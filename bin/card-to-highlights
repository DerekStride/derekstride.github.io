#!/usr/bin/env ruby

require "bundler/setup"
require "optparse"
require "logger"
require "json"
require "debug"

$stdout.sync = $stderr.sync = true
def level = ENV.fetch("LOG_LEVEL", Logger::WARN)
def progname = File.basename($0)
def logger = @logger ||= Logger.new($stderr, level:, progname:)
def options = @options ||= {}
def enoent!(pathname) = logger.error("File not found: #{pathname}") && exit(Errno::ENOENT::Errno)

OptionParser.new do |o|
  o.accept(Pathname) { Pathname.new(_1) }

  o.banner = "usage: ruby #{progname} [options]"
  o.on("-v", "--verbose", "Enable verbose logging") { logger.level -= 1 }
  o.on("-f", "--file=FILE", Pathname, "Path to hashcards JSON file (default: tmp/hashcards.json)") { |file| options[:file] = file.exist? ? file : enoent!(file) }
  o.on("-o", "--output=FILE", Pathname, "Path to output highlights JSON file (default: stdout)") { |file| options[:output] = file }
end.parse!(ARGV, into: options)

options[:file] ||= Pathname.new("tmp/hashcards.json").then { _1.exist? ? _1 : enoent!(_1) }

logger.debug("options=#{options}")

def card_to_highlight(card)
  content = card["content"]
  text = if content["cloze"]
    content["cloze"]["text"]
  elsif content["frontBack"]
    "Q: #{content["frontBack"]["front"]}\nA: #{content["frontBack"]["back"]}"
  else
    logger.warn("Unknown card content type: #{content.keys}")
    return nil
  end

  note = if content["cloze"]
    "cloze: [#{content["cloze"]["start"]}-#{content["cloze"]["end"]}]"
  else
    nil
  end

  {
    text: text,
    title: card["deckName"],
    source_type: "hashcards",
    category: "books",
    note: note,
    highlight_url: "hashcards://#{card["hash"]}"
  }.compact
end

def main
  hashcards = JSON.parse(options[:file].read)
  logger.info("Loaded #{hashcards["cards"].size} cards from #{options[:file]}")

  highlights = hashcards["cards"].filter_map { |card| card_to_highlight(card) }
  logger.info("Converted #{highlights.size} highlights")

  output = JSON.pretty_generate({ highlights: highlights })

  if options[:output]
    options[:output].write(output)
    logger.info("Wrote highlights to #{options[:output]}")
  else
    puts output
  end
end

main
